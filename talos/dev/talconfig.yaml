clusterName: dk8s
# renovate: datasource=docker depName=ghcr.io/siderolabs/installer
talosVersion: v1.11.3
kubernetesVersion: v1.34.1
endpoint: https://192.168.40.13:6443 # Talos endpoint, the VIP
allowSchedulingOnControlPlanes: true
cniConfig:
  name: "none"
controlPlane:
  patches:
    - "@./patches/longhorn.yaml"
  schematic:
    customization:
      extraKernelArgs:
        - net.ifnames=0
nodes:
  - hostname: "d-hpp-1-lab"
    ipAddress: 192.168.40.11
    controlPlane: true
    installDisk: /dev/nvme0n1
    userVolumes: &uservolumes
      # will mount to /var/mnt/longhorn
      - name: longhorn
        provisioning:
          grow: true
          minSize: 10GB
          diskSelector:
            match: disk.transport == "sata" && !disk.rotational && !system_disk
        filesystem:
          type: xfs
    networkInterfaces:
      - interface: eth0
        dhcp: true
        vip: &vip
          ip: 192.168.40.13
        vlans:
          - vlanId: 15
            addresses:
              - "192.168.15.31/24" #20 plus lab address
            routes:
              - network: 192.168.15.0/24
                gateway: 192.168.15.1
          - vlanId: 30
            addresses:
              - "192.168.30.41/24" #30 plus lab address
            routes:
              - network: 192.168.30.0/24
                gateway: 192.168.30.1
    machineFiles: &machinefiles
      - content: |
          [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
        op: create
        path: /etc/cri/conf.d/20-customization.part
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/intel-ucode
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
  - hostname: "d-hpp-2-lab"
    ipAddress: 192.168.40.7
    controlPlane: true
    installDisk: /dev/nvme0n1
    userVolumes: *uservolumes
    networkInterfaces:
      - interface: eth0
        dhcp: true
        vip: *vip
        vlans:
          - vlanId: 15
            addresses:
              - "192.168.15.27/24" #20 plus lab address
            routes:
              - network: 192.168.15.0/24
                gateway: 192.168.15.1
          - vlanId: 30
            addresses:
              - "192.168.30.37/24" #30 plus lab address
            routes:
              - network: 192.168.30.0/24
                gateway: 192.168.30.1
    machineFiles: *machinefiles
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/intel-ucode
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
  - hostname: "d-hpp-3-lab"
    ipAddress: 192.168.40.9
    controlPlane: true
    installDisk: /dev/nvme0n1
    userVolumes: *uservolumes
    networkInterfaces:
      - interface: eth0
        dhcp: true
        vip: *vip
        vlans:
          - vlanId: 15
            addresses:
              - "192.168.15.29/24" #20 plus lab address
            routes:
              - network: 192.168.15.0/24
                gateway: 192.168.15.1
          - vlanId: 30
            addresses:
              - "192.168.30.39/24" #30 plus lab address
            routes:
              - network: 192.168.30.0/24
                gateway: 192.168.30.1
    machineFiles: *machinefiles
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/intel-ucode
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
